@startuml secuencia
!pragma teoz true
' Definicion de participantes
participant Hilo1
participant Hilo2
participant Monitor
participant Mutex
participant Red_de_petri
participant Colas 
participant Politicas
participant SensibilizadoConTiempo

' Secuencia
'' El hilo intenta disparar una Transicion
activate Hilo1
Hilo1 -> Monitor : fireTransition(Tn)
note left: El hilo intenta disparar la transicion Tn
activate Monitor

'' El monitor toma el mutex
Monitor -> Mutex : acquire()
note left: Toma el mutex
activate Mutex
Mutex --> Monitor
deactivate Mutex

Monitor -> Monitor : k=true
activate Monitor
deactivate Monitor

loop k==true
    Monitor -> Red_de_petri : dispararTransicion(Tn)
    activate Red_de_petri
    Red_de_petri -> Red_de_petri : sensibilizado(Tn)
    note left 
    Le indica a la red 
    que transicion se dispara
    end note
    ''activate Red_de_petri
    Red_de_petri --> Monitor : se_disparo
    alt se_disparo == true
        Monitor -> Red_de_petri : verificarConflicto()
        Red_de_petri -> Politicas : llamadaPolitica()
        activate Politicas
        Politicas --> Red_de_petri : Tn (a despertar)
        deactivate Politicas
        Red_de_petri --> Monitor : Tn
        
        alt Tn >= 0
            Monitor -> Colas : notificar(Tn)
            activate Colas
            deactivate Colas
        else Tn < 0
          Monitor -> Red_de_petri : getSensibilizados()
          Red_de_petri --> Monitor : Vs
            Monitor -> Colas : notificar(Vs)
            activate Colas
            Colas --> Monitor
            deactivate Colas  
        end 
        Monitor -> Mutex : release()
        activate Mutex
        Mutex --> Monitor
        deactivate Mutex
        Monitor --> Hilo1 : Sale del monitor
        deactivate Hilo1
        Monitor -> Hilo2 : se activa el hilo
        activate Hilo2
        /'Monitor -> Red_de_petri : getSensibilizados()
        note right
        Devuelve un vector
        con las transiciones sencibilizadas
        despues del cambio de estado
        end note
        Red_de_petri --> Monitor : Vs
        Monitor -> Colas : notificar(Vs)
        activate Colas
        Colas --> Monitor
        deactivate Colas
        /'
        Monitor -> Colas : quienesEstan()
        activate Colas
        note right
        Devuelve un vector
        con las colas que tienen
        procesos bloqueados
        end note
        Colas --> Monitor : Vc
        deactivate Colas
        Monitor -> Monitor : m = Vs and Vc
        note left 
        Nos dice las Transiciones 
        sencibilizadas con procesos 
        esperando
        end note
        alt m<>0 (Hay hilos esperando)
            Monitor-> Red_de_petri : cualDisparar(m)
            & Red_de_petri -> Politicas : cualDisparar(m)
            activate Politicas
            Politicas --> Monitor : NumeroTransicion
            deactivate Politicas
            Monitor --> Hilo1 : Sale del monitor
            deactivate Hilo1
            Monitor -> Colas : release()
            activate Colas
            Colas --> Monitor
            deactivate Colas
            Monitor --> Hilo2 : se activa el hilo
            activate Hilo2
        else m == 0 (No hay hilos esperando)
            Monitor -> Monitor : k=false
            activate Monitor
            deactivate Monitor
        end
        '/
    else se_disparo == false
        Monitor -> Mutex : release()
        activate Mutex
        Mutex --> Monitor
        deactivate Mutex
        Monitor -> Colas : dormirHilo()
        activate Colas
        Colas --> Monitor
        deactivate Colas
        Monitor-> Colas : acquire()
        activate Colas
        Colas --> Monitor
        deactivate Colas

    end
    Hilo2 -> Monitor : continua ejecucion
end
deactivate Hilo2


@enduml